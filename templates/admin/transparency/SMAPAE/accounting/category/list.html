{% load static %}
<div class="container mx-auto p-4">
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-300 rounded-lg shadow">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Orden</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nombre</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Acciones</th>
                </tr>
            </thead>
            <tbody id="sortable-table" class="divide-y divide-gray-200">
                {% for item in listCategories %}
                <tr class="sortable-row hover:bg-gray-50 cursor-move transition-colors" 
                    data-id="{{ item.id }}" 
                    draggable="true">
                    <td class="px-4 py-3 text-sm text-gray-600">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                        </svg>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">{{ item.name }}</td>
                    <td>
                        <div class="flex items-center">
                            <!--Detail-->
                            <a  data-tooltip-target="tooltip-ShowDetail-{{item.id}}" onClick="openModalDetail()" hx-get="{% url 'AccountingDetailCategory' item.id %}" hx-target="#bodyModalDetail" 
                            class="cursor-pointer font-medium text-gray-600 dark:text-gray-500 hover:underline">
                                <i class="fas fa-eye"></i>
                                    <div id="tooltip-ShowDetail-{{item.id}}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                    Detalle
                                    <div class="tooltip-arrow" data-popper-arrow></div>
                                </div>
                            </a>
                            <!--Detail-->
                            <!--Edit-->
                            <a data-tooltip-target="tooltip-EditCat-{{item.id}}" onClick="OpenSmallModal()" hx-get="{% url 'AccountingEditCategory' item.id %}" hx-target="#body-small-modal"  
                            class="px-2 cursor-pointer font-medium text-blue-600 dark:text-blue-500 hover:underline">
                                <i class="fas fa-pen-to-square"></i>
                                <div id="tooltip-EditCat-{{item.id}}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                    Editar
                                    <div class="tooltip-arrow" data-popper-arrow></div>
                                </div>
                            </a>
                            <!--Edit-->
                            <!--Delete-->
                            <a data-tooltip-target="tooltip-DeleteCat-{{item.id}}" onClick="OpenSmallModal()" hx-get="{% url 'AccountingDeleteCategory' item.id %}" hx-target="#body-small-modal" 
                            class="px-2 cursor-pointer font-medium text-red-600 dark:text-red-500 hover:underline">
                                <i class="fas fa-trash"></i>
                                <div id="tooltip-DeleteCat-{{item.id}}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                    Eliminar
                                    <div class="tooltip-arrow" data-popper-arrow></div>
                                </div>
                            </a>
                            <!--Delete-->                            
                        </div>                       
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function initializeDragAndDrop() {
        const tbody = document.getElementById('sortable-table');
        if (!tbody) return;

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('opacity-50');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            if (this !== draggedElement) {
                this.classList.add('border-t-4', 'border-blue-500');
            }
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const allRows = [...tbody.querySelectorAll('.sortable-row')];
                const draggedIndex = allRows.indexOf(draggedElement);
                const targetIndex = allRows.indexOf(this);

                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedElement, this);
                }

                updateOrder();
            }

            this.classList.remove('border-t-4', 'border-blue-500');
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('opacity-50');
            document.querySelectorAll('.sortable-row').forEach(row => {
                row.classList.remove('border-t-4', 'border-blue-500');
            });
        }

        function updateOrder() {
            const rows = tbody.querySelectorAll('.sortable-row');
            const order = [];
            
            rows.forEach((row, index) => {
                order.push({
                    id: row.dataset.id,
                    order: index + 1
                });
            });

            fetch("{% url 'actualizar_orden' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ order: order })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Orden actualizado correctamente');
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Remover listeners anteriores si existen
        tbody.querySelectorAll('.sortable-row').forEach(row => {
            const newRow = row.cloneNode(true);
            row.parentNode.replaceChild(newRow, row);
        });

        // Agregar event listeners
        tbody.querySelectorAll('.sortable-row').forEach(row => {
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('drop', handleDrop);
            row.addEventListener('dragend', handleDragEnd);
        });
    }

    // Ejecutar al cargar la página
    document.addEventListener('DOMContentLoaded', initializeDragAndDrop);

    // Ejecutar después de cada actualización de HTMX
    document.addEventListener('htmx:afterSwap', function(event) {
        // Solo reinicializar si el evento afectó a nuestra tabla
        if (event.detail.target.querySelector('#sortable-table') || 
            event.detail.target.id === 'sortable-table') {
            initializeDragAndDrop();
        }
    });

    // También escuchar el evento personalizado
    document.addEventListener('UpdateListCategories', function() {
        // Pequeño delay para asegurar que el DOM se actualizó
        setTimeout(initializeDragAndDrop, 100);
    });
</script>