{% extends "layouts/blank.html" %}
{% load static %}
{%block page_title%}
<!--breadcrumb-->
<nav class="hidden md:block" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
        <li class="inline-flex items-center">
            <a href="#" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
            <svg class="w-3 h-3 me-2.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                <path d="M10.464 8.746c.227-.18.497-.311.786-.394v2.795a2.252 2.252 0 0 1-.786-.393c-.394-.313-.546-.681-.546-1.004 0-.323.152-.691.546-1.004ZM12.75 15.662v-2.824c.347.085.664.228.921.421.427.32.579.686.579.991 0 .305-.152.671-.579.991a2.534 2.534 0 0 1-.921.42Z" />
                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v.816a3.836 3.836 0 0 0-1.72.756c-.712.566-1.112 1.35-1.112 2.178 0 .829.4 1.612 1.113 2.178.502.4 1.102.647 1.719.756v2.978a2.536 2.536 0 0 1-.921-.421l-.879-.66a.75.75 0 0 0-.9 1.2l.879.66c.533.4 1.169.645 1.821.75V18a.75.75 0 0 0 1.5 0v-.81a4.124 4.124 0 0 0 1.821-.749c.745-.559 1.179-1.344 1.179-2.191 0-.847-.434-1.632-1.179-2.191a4.122 4.122 0 0 0-1.821-.75V8.354c.29.082.559.213.786.393l.415.33a.75.75 0 0 0 .933-1.175l-.415-.33a3.836 3.836 0 0 0-1.719-.755V6Z" clip-rule="evenodd" />
            </svg> 
            Tesorería
            </a>
        </li>
        <li>
            <div class="flex items-center">
            <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
            </svg>
            <a href="#" class="ms-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ms-2 dark:text-gray-400 dark:hover:text-white">
                Ingresos</a>
            </div>
        </li>      
        <li>
            <div class="flex items-center">
            <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
            </svg>
            <a href="#" class="ms-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ms-2 dark:text-gray-400 dark:hover:text-white">
                Facturacion</a>
            </div>
        </li>         
    </ol>
</nav>
<!--breadcrumb-->
{%endblock%}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-receipt"></i> Facturas
    </h1>
    <a href="{% url 'factura-create' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Nueva Factura
    </a>
</div>

<!-- Filtros de búsqueda -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label for="search" class="form-label">Buscar</label>
                <input type="text" class="form-control" id="search" name="search" 
                       placeholder="UUID, Folio o Cliente" value="{{ request.GET.search }}">
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Estado</label>
                <select class="form-select" id="status" name="status">
                    <option value="">Todos</option>
                    <option value="DRAFT" {% if request.GET.status == 'DRAFT' %}selected{% endif %}>Borrador</option>
                    <option value="TIMBRADA" {% if request.GET.status == 'TIMBRADA' %}selected{% endif %}>Timbrada</option>
                    <option value="CANCELADA" {% if request.GET.status == 'CANCELADA' %}selected{% endif %}>Cancelada</option>
                    <option value="ERROR" {% if request.GET.status == 'ERROR' %}selected{% endif %}>Error</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="fecha_desde" class="form-label">Fecha desde</label>
                <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" 
                       value="{{ request.GET.fecha_desde }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Buscar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Estadísticas rápidas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-value">{{ stats.timbradas|default:0 }}</div>
                    <div class="stat-label">Timbradas</div>
                </div>
                <i class="bi bi-check-circle"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-value">{{ stats.borradores|default:0 }}</div>
                    <div class="stat-label">Borradores</div>
                </div>
                <i class="bi bi-file-earmark"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-value">{{ stats.canceladas|default:0 }}</div>
                    <div class="stat-label">Canceladas</div>
                </div>
                <i class="bi bi-x-circle"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #1a5490 0%, #2d6ba8 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-value">${{ stats.total_mes|default:0|floatformat:2 }}</div>
                    <div class="stat-label">Total del mes</div>
                </div>
                <i class="bi bi-cash-stack"></i>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de facturas -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-list-ul"></i> Lista de Facturas
    </div>
    <div class="card-body p-0">
        {% if facturas %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Folio</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>UUID</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for factura in facturas %}
                        <tr>
                            <td>
                                <strong>{{ factura.serie }}{{ factura.folio }}</strong>
                            </td>
                            <td>{{ factura.fecha|date:"d/m/Y H:i" }}</td>
                            <td>
                                <div>{{ factura.cliente.razon_social|truncatechars:30 }}</div>
                                <small class="text-muted">{{ factura.cliente.rfc }}</small>
                            </td>
                            <td>
                                {% if factura.uuid %}
                                    <small class="font-monospace">{{ factura.uuid|truncatechars:15 }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>${{ factura.total|floatformat:2 }}</strong>
                                <small class="text-muted d-block">{{ factura.moneda }}</small>
                            </td>
                            <td>
                                {% if factura.status == 'TIMBRADA' %}
                                    <span class="badge status-timbrada">
                                        <i class="bi bi-check-circle"></i> Timbrada
                                    </span>
                                {% elif factura.status == 'DRAFT' %}
                                    <span class="badge status-draft">
                                        <i class="bi bi-file-earmark"></i> Borrador
                                    </span>
                                {% elif factura.status == 'CANCELADA' %}
                                    <span class="badge status-cancelada">
                                        <i class="bi bi-x-circle"></i> Cancelada
                                    </span>
                                {% elif factura.status == 'ERROR' %}
                                    <span class="badge status-error">
                                        <i class="bi bi-exclamation-triangle"></i> Error
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'factura-detail' factura.pk %}" 
                                       class="btn btn-outline-primary" 
                                       title="Ver detalle">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    
                                    {% if factura.status == 'DRAFT' %}
                                        <button onclick="timbrarFactura({{ factura.pk }})" 
                                                class="btn btn-outline-success" 
                                                title="Timbrar">
                                            <i class="bi bi-send"></i>
                                        </button>
                                    {% endif %}
                                    
                                    {% if factura.status == 'TIMBRADA' %}
                                        <a href="{% url 'factura-descargar-xml' factura.pk %}" 
                                           class="btn btn-outline-info" 
                                           title="Descargar XML">
                                            <i class="bi bi-file-code"></i>
                                        </a>
                                        <a href="{% url 'factura-descargar-pdf' factura.pk %}" 
                                           class="btn btn-outline-danger" 
                                           title="Descargar PDF">
                                            <i class="bi bi-file-pdf"></i>
                                        </a>
                                        <button onclick="cancelarFactura({{ factura.pk }})" 
                                                class="btn btn-outline-warning" 
                                                title="Cancelar">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación -->
            {% if is_paginated %}
            <div class="card-footer">
                <nav>
                    <ul class="pagination justify-content-center mb-0">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                                    <i class="bi bi-chevron-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">
                                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                            </span>
                        </li>
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                                    <i class="bi bi-chevron-double-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                <p class="text-muted mt-3">No hay facturas para mostrar</p>
                <a href="{% url 'factura-create' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Crear primera factura
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function timbrarFactura(facturaId) {
    Swal.fire({
        title: '¿Timbrar factura?',
        text: "Esta acción enviará la factura al PAC para su timbrado",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-send"></i> Sí, timbrar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Mostrar loading
            Swal.fire({
                title: 'Timbrando factura...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Enviar petición para timbrar
            fetch(`/facturas/${facturaId}/timbrar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Factura timbrada!',
                        html: `UUID: <code>${data.uuid}</code>`,
                        confirmButtonText: 'Ver factura'
                    }).then(() => {
                        window.location.href = `/facturas/${facturaId}/`;
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al timbrar',
                        text: data.error
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al procesar la solicitud'
                });
            });
        }
    });
}

function cancelarFactura(facturaId) {
    Swal.fire({
        title: '¿Cancelar factura?',
        html: `
            <p>Esta acción cancelará la factura ante el SAT</p>
            <select id="motivo-cancelacion" class="form-select">
                <option value="02">Comprobante emitido con errores sin relación</option>
                <option value="01">Comprobante emitido con errores con relación</option>
                <option value="03">No se llevó a cabo la operación</option>
                <option value="04">Operación nominativa relacionada en factura global</option>
            </select>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-x-circle"></i> Sí, cancelar',
        cancelButtonText: 'No cancelar',
        preConfirm: () => {
            return document.getElementById('motivo-cancelacion').value;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Cancelando factura...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            fetch(`/facturas/${facturaId}/cancelar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ motivo: result.value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Factura cancelada',
                        text: 'La factura ha sido cancelada exitosamente'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al cancelar',
                        text: data.error
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al procesar la solicitud'
                });
            });
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}