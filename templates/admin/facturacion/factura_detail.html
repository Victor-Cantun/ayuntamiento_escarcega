{% extends "layouts/blank.html" %}
{% load static %}
{%block page_title%}
<!--breadcrumb-->
<nav class="hidden md:block" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
        <li class="inline-flex items-center">
            <a href="#" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
            <svg class="w-3 h-3 me-2.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                <path d="M10.464 8.746c.227-.18.497-.311.786-.394v2.795a2.252 2.252 0 0 1-.786-.393c-.394-.313-.546-.681-.546-1.004 0-.323.152-.691.546-1.004ZM12.75 15.662v-2.824c.347.085.664.228.921.421.427.32.579.686.579.991 0 .305-.152.671-.579.991a2.534 2.534 0 0 1-.921.42Z" />
                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v.816a3.836 3.836 0 0 0-1.72.756c-.712.566-1.112 1.35-1.112 2.178 0 .829.4 1.612 1.113 2.178.502.4 1.102.647 1.719.756v2.978a2.536 2.536 0 0 1-.921-.421l-.879-.66a.75.75 0 0 0-.9 1.2l.879.66c.533.4 1.169.645 1.821.75V18a.75.75 0 0 0 1.5 0v-.81a4.124 4.124 0 0 0 1.821-.749c.745-.559 1.179-1.344 1.179-2.191 0-.847-.434-1.632-1.179-2.191a4.122 4.122 0 0 0-1.821-.75V8.354c.29.082.559.213.786.393l.415.33a.75.75 0 0 0 .933-1.175l-.415-.33a3.836 3.836 0 0 0-1.719-.755V6Z" clip-rule="evenodd" />
            </svg> 
            Tesorería
            </a>
        </li>
        <li>
            <div class="flex items-center">
            <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
            </svg>
            <a href="#" class="ms-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ms-2 dark:text-gray-400 dark:hover:text-white">
                Ingresos</a>
            </div>
        </li>      
        <li>
            <div class="flex items-center">
            <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
            </svg>
            <a href="#" class="ms-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ms-2 dark:text-gray-400 dark:hover:text-white">
                Facturacion</a>
            </div>
        </li>         
    </ol>
</nav>
<!--breadcrumb-->
{%endblock%}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{% url 'factura-list' %}" class="btn btn-outline-secondary btn-sm mb-2">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
        <h1 class="h3 mb-0">
            <i class="bi bi-receipt"></i> Factura {{ factura.serie }}{{ factura.folio }}
        </h1>
    </div>
    <div>
        {% if factura.status == 'DRAFT' %}
            <button onclick="timbrarFactura({{ factura.pk }})" class="btn btn-success">
                <i class="bi bi-send"></i> Timbrar
            </button>
        {% elif factura.status == 'TIMBRADA' %}
            <div class="btn-group">
                <a href="{% url 'factura-descargar-xml' factura.pk %}" class="btn btn-info">
                    <i class="bi bi-file-code"></i> XML
                </a>
                <a href="{% url 'factura-descargar-pdf' factura.pk %}" class="btn btn-danger">
                    <i class="bi bi-file-pdf"></i> PDF
                </a>
                <button onclick="cancelarFactura({{ factura.pk }})" class="btn btn-warning">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Estado de la factura -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="card-title mb-3">Estado de la Factura</h5>
                        <div class="mb-2">
                            {% if factura.status == 'TIMBRADA' %}
                                <span class="badge status-timbrada fs-6">
                                    <i class="bi bi-check-circle"></i> TIMBRADA
                                </span>
                            {% elif factura.status == 'DRAFT' %}
                                <span class="badge status-draft fs-6">
                                    <i class="bi bi-file-earmark"></i> BORRADOR
                                </span>
                            {% elif factura.status == 'CANCELADA' %}
                                <span class="badge status-cancelada fs-6">
                                    <i class="bi bi-x-circle"></i> CANCELADA
                                </span>
                            {% elif factura.status == 'ERROR' %}
                                <span class="badge status-error fs-6">
                                    <i class="bi bi-exclamation-triangle"></i> ERROR
                                </span>
                            {% endif %}
                        </div>
                        
                        {% if factura.uuid %}
                        <div class="mt-3">
                            <strong>UUID (Folio Fiscal):</strong>
                            <div class="input-group mt-2">
                                <input type="text" class="form-control font-monospace" 
                                       value="{{ factura.uuid }}" id="uuid-input" readonly>
                                <button class="btn btn-outline-secondary" type="button" 
                                        onclick="copiarUUID()">
                                    <i class="bi bi-clipboard"></i> Copiar
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        <h2 class="text-primary mb-0">${{ factura.total|floatformat:2 }}</h2>
                        <p class="text-muted">{{ factura.moneda }}</p>
                        <small class="text-muted">
                            Creada: {{ factura.created_at|date:"d/m/Y H:i" }}
                        </small>
                        {% if factura.fecha_timbrado %}
                        <br>
                        <small class="text-muted">
                            Timbrada: {{ factura.fecha_timbrado|date:"d/m/Y H:i" }}
                        </small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Información Emisor y Receptor -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-building"></i> Emisor
            </div>
            <div class="card-body">
                <h5 class="card-title">{{ factura.emisor.razon_social }}</h5>
                <p class="mb-2"><strong>RFC:</strong> {{ factura.emisor.rfc }}</p>
                <p class="mb-2"><strong>Régimen Fiscal:</strong> {{ factura.emisor.regimen_fiscal }}</p>
                <p class="mb-0"><strong>Código Postal:</strong> {{ factura.emisor.codigo_postal }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-person"></i> Receptor (Cliente)
            </div>
            <div class="card-body">
                <h5 class="card-title">{{ factura.cliente.razon_social }}</h5>
                <p class="mb-2"><strong>RFC:</strong> {{ factura.cliente.rfc }}</p>
                <p class="mb-2"><strong>Régimen Fiscal:</strong> {{ factura.cliente.regimen_fiscal }}</p>
                <p class="mb-2"><strong>Uso CFDI:</strong> {{ factura.cliente.uso_cfdi }}</p>
                <p class="mb-0"><strong>Código Postal:</strong> {{ factura.cliente.codigo_postal }}</p>
                {% if factura.cliente.email %}
                <p class="mb-0 mt-2">
                    <i class="bi bi-envelope"></i> {{ factura.cliente.email }}
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Datos de la Factura -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-info-circle"></i> Datos de la Factura
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <p class="mb-2"><strong>Serie:</strong> {{ factura.serie|default:"-" }}</p>
            </div>
            <div class="col-md-3">
                <p class="mb-2"><strong>Folio:</strong> {{ factura.folio|default:"-" }}</p>
            </div>
            <div class="col-md-3">
                <p class="mb-2"><strong>Fecha:</strong> {{ factura.fecha|date:"d/m/Y H:i:s" }}</p>
            </div>
            <div class="col-md-3">
                <p class="mb-2"><strong>Lugar de Expedición:</strong> {{ factura.emisor.codigo_postal }}</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-3">
                <p class="mb-2"><strong>Forma de Pago:</strong> {{ factura.forma_pago }}</p>
            </div>
            <div class="col-md-3">
                <p class="mb-2"><strong>Método de Pago:</strong> {{ factura.metodo_pago }}</p>
            </div>
            <div class="col-md-3">
                <p class="mb-2"><strong>Tipo de Comprobante:</strong> {{ factura.get_tipo_comprobante_display }}</p>
            </div>
            <div class="col-md-3">
                <p class="mb-2"><strong>Moneda:</strong> {{ factura.moneda }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Conceptos -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-list-check"></i> Conceptos
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Cantidad</th>
                        <th>Unidad</th>
                        <th>Descripción</th>
                        <th class="text-end">Precio Unitario</th>
                        <th class="text-end">Importe</th>
                    </tr>
                </thead>
                <tbody>
                    {% for concepto in factura.conceptos.all %}
                    <tr>
                        <td>{{ concepto.cantidad }}</td>
                        <td>
                            {{ concepto.clave_unidad }}
                            {% if concepto.unidad %}
                            <br><small class="text-muted">{{ concepto.unidad }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ concepto.descripcion }}</strong>
                            <br>
                            <small class="text-muted">
                                Clave: {{ concepto.clave_prod_serv }}
                                {% if concepto.no_identificacion %}
                                | SKU: {{ concepto.no_identificacion }}
                                {% endif %}
                            </small>
                            
                            <!-- Mostrar impuestos del concepto -->
                            {% if concepto.impuestos_trasladados.all or concepto.impuestos_retenidos.all %}
                            <div class="mt-2">
                                {% for imp in concepto.impuestos_trasladados.all %}
                                <span class="badge bg-info me-1">
                                    {{ imp.get_impuesto_display }} {{ imp.tasa_o_cuota|floatformat:2 }}%: 
                                    ${{ imp.importe|floatformat:2 }}
                                </span>
                                {% endfor %}
                                {% for imp in concepto.impuestos_retenidos.all %}
                                <span class="badge bg-warning me-1">
                                    Ret. {{ imp.get_impuesto_display }} {{ imp.tasa_o_cuota|floatformat:2 }}%: 
                                    ${{ imp.importe|floatformat:2 }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </td>
                        <td class="text-end">${{ concepto.valor_unitario|floatformat:2 }}</td>
                        <td class="text-end"><strong>${{ concepto.importe|floatformat:2 }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Totales -->
<div class="row mb-4">
    <div class="col-md-8"></div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tr>
                        <td><strong>Subtotal:</strong></td>
                        <td class="text-end">${{ factura.subtotal|floatformat:2 }}</td>
                    </tr>
                    {% if factura.descuento > 0 %}
                    <tr>
                        <td><strong>Descuento:</strong></td>
                        <td class="text-end text-danger">-${{ factura.descuento|floatformat:2 }}</td>
                    </tr>
                    {% endif %}
                    
                    {% with total_iva=0 total_ret=0 %}
                    {% for concepto in factura.conceptos.all %}
                        {% for imp in concepto.impuestos_trasladados.all %}
                            {% if imp.impuesto == '002' %}
                                <tr>
                                    <td>IVA ({{ imp.tasa_o_cuota|floatformat:2 }}%):</td>
                                    <td class="text-end">${{ imp.importe|floatformat:2 }}</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        {% for imp in concepto.impuestos_retenidos.all %}
                            <tr>
                                <td>Ret. {{ imp.get_impuesto_display }}:</td>
                                <td class="text-end text-danger">-${{ imp.importe|floatformat:2 }}</td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                    {% endwith %}
                    
                    <tr class="border-top">
                        <td><h5 class="mb-0">Total:</h5></td>
                        <td class="text-end"><h5 class="mb-0 text-primary">${{ factura.total|floatformat:2 }}</h5></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Información Fiscal (si está timbrada) -->
{% if factura.status == 'TIMBRADA' %}
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-shield-check"></i> Información Fiscal del Timbrado
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p class="mb-2"><strong>UUID (Folio Fiscal):</strong></p>
                <p class="font-monospace text-break">{{ factura.uuid }}</p>
            </div>
            <div class="col-md-6">
                <p class="mb-2"><strong>Fecha de Timbrado:</strong></p>
                <p>{{ factura.fecha_timbrado|date:"d/m/Y H:i:s" }}</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <p class="mb-2"><strong>No. Certificado SAT:</strong></p>
                <p class="font-monospace">{{ factura.certificado_sat|default:"-" }}</p>
            </div>
            <div class="col-md-6">
                <p class="mb-2"><strong>Validar en SAT:</strong></p>
                <a href="https://verificacfdi.facturaelectronica.sat.gob.mx/" 
                   target="_blank" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-box-arrow-up-right"></i> Verificar en SAT
                </a>
            </div>
        </div>
        
        {% if factura.sello_cfdi %}
        <div class="row mt-3">
            <div class="col-12">
                <p class="mb-2"><strong>Sello Digital del CFDI:</strong></p>
                <textarea class="form-control font-monospace" rows="3" readonly>{{ factura.sello_cfdi }}</textarea>
            </div>
        </div>
        {% endif %}
        
        {% if factura.cadena_original %}
        <div class="row mt-3">
            <div class="col-12">
                <p class="mb-2"><strong>Cadena Original del Complemento:</strong></p>
                <textarea class="form-control font-monospace" rows="2" readonly>{{ factura.cadena_original }}</textarea>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Notas -->
{% if factura.notas %}
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-sticky"></i> Notas
    </div>
    <div class="card-body">
        <p class="mb-0">{{ factura.notas }}</p>
    </div>
</div>
{% endif %}

<!-- Logs de Timbrado -->
{% if factura.logs_timbrado.all %}
<div class="card">
    <div class="card-header">
        <i class="bi bi-clock-history"></i> Historial de Timbrado
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Estado</th>
                        <th>Mensaje</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in factura.logs_timbrado.all %}
                    <tr>
                        <td>{{ log.fecha|date:"d/m/Y H:i:s" }}</td>
                        <td>
                            {% if log.exitoso %}
                                <span class="badge bg-success">Exitoso</span>
                            {% else %}
                                <span class="badge bg-danger">Error</span>
                            {% endif %}
                        </td>
                        <td>{{ log.mensaje }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
function copiarUUID() {
    const uuidInput = document.getElementById('uuid-input');
    uuidInput.select();
    document.execCommand('copy');
    
    Swal.fire({
        icon: 'success',
        title: 'UUID copiado',
        text: 'El UUID ha sido copiado al portapapeles',
        timer: 1500,
        showConfirmButton: false
    });
}

function timbrarFactura(facturaId) {
    Swal.fire({
        title: '¿Timbrar factura?',
        text: "Esta acción enviará la factura al PAC para su timbrado",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-send"></i> Sí, timbrar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Timbrando factura...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            fetch(`/facturas/${facturaId}/timbrar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Factura timbrada!',
                        html: `UUID: <code>${data.uuid}</code>`,
                        confirmButtonText: 'Recargar'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al timbrar',
                        text: data.error
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al procesar la solicitud'
                });
            });
        }
    });
}

function cancelarFactura(facturaId) {
    Swal.fire({
        title: '¿Cancelar factura?',
        html: `
            <p>Esta acción cancelará la factura ante el SAT</p>
            <select id="motivo-cancelacion" class="form-select">
                <option value="02">Comprobante emitido con errores sin relación</option>
                <option value="01">Comprobante emitido con errores con relación</option>
                <option value="03">No se llevó a cabo la operación</option>
                <option value="04">Operación nominativa relacionada en factura global</option>
            </select>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-x-circle"></i> Sí, cancelar',
        cancelButtonText: 'No cancelar',
        preConfirm: () => {
            return document.getElementById('motivo-cancelacion').value;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Cancelando factura...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            fetch(`/facturas/${facturaId}/cancelar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ motivo: result.value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Factura cancelada',
                        text: 'La factura ha sido cancelada exitosamente'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al cancelar',
                        text: data.error
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al procesar la solicitud'
                });
            });
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}